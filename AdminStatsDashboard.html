<style>
    .page-header { font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; }
     .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 1.5rem; 
    }
    .page-header { font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; }
    .stat-card { background-color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
    .stat-card-info .title { color: #6b7280; font-size: 0.875rem; margin: 0 0 0.25rem 0; }
    .stat-card-info .value { font-size: 2.25rem; font-weight: 700; color: #111827; margin: 0; }
    .stat-card-icon { font-size: 1.5rem; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; }
    .stat-card.users { border-left-color: #ef4444; }
    .stat-card.alumni { border-left-color: #f97316; }
    .stat-card.students { border-left-color: #3b82f6; }
    .stat-card.passed { border-left-color: #16a34a; }
    .stat-card.rate { border-left-color: #8b5cf6; } /* สีใหม่ */
    .icon-users { background-color: #ef4444; }
    .icon-alumni { background-color: #f97316; }
    .icon-students { background-color: #3b82f6; }
    .icon-passed { background-color: #16a34a; }
    .icon-rate { background-color: #8b5cf6; } /* สีใหม่ */
    
    .tabs-container { border-bottom: 2px solid #e5e7eb; margin-top: 2.5rem; margin-bottom: 1.5rem; }
    .tab-button { padding: 0.75rem 1.5rem; border: none; background-color: transparent; cursor: pointer; font-size: 1rem; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
    .chart-card { background-color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
    .chart-card h3 { margin-top: 0; font-size: 1.125rem; color: #374151; }
    .chart-placeholder { min-height: 280px; display: flex; justify-content: center; align-items: center; color: #9ca3af; background-color: #f9fafb; border-radius: 8px; }
</style>

<h2 class="page-header">แดชบอร์ด</h2>
<div class="stats-grid">
    <div class="stat-card users"><div class="stat-card-info"><p class="title">ผู้ใช้ทั้งหมด</p><p id="totalUsers" class="value">0</p></div><div class="stat-card-icon icon-users"><i class="fas fa-users"></i></div></div>
    <div class="stat-card alumni"><div class="stat-card-info"><p class="title">ศิษย์เก่า</p><p id="alumniCount" class="value">0</p></div><div class="stat-card-icon icon-alumni"><i class="fas fa-graduation-cap"></i></div></div>
    <div class="stat-card students"><div class="stat-card-info"><p class="title">นักศึกษาปัจจุบัน</p><p id="studentCount" class="value">0</p></div><div class="stat-card-icon icon-students"><i class="fas fa-user-graduate"></i></div></div>
    <div class="stat-card passed"><div class="stat-card-info"><p class="title">ผู้ที่สอบผ่านทั้งหมด</p><p id="passedAllCount" class="value">0</p></div><div class="stat-card-icon icon-passed"><i class="fas fa-user-check"></i></div></div>
    <div class="stat-card rate">
        <div class="stat-card-info">
            <p class="title">อัตราผ่าน</p>
            <p id="passRate" class="value">0%</p>
        </div>
        <div class="stat-card-icon icon-rate">
            <i class="fas fa-percentage"></i>
        </div>
    </div>
</div>

<div class="tabs-container">
    <button class="tab-button active" onclick="showTab(event, 'demographics')">ข้อมูลประชากร</button>
    <button class="tab-button" onclick="showTab(event, 'employment')">การทำงาน</button>
    <button class="tab-button" onclick="showTab(event, 'license')">ใบประกอบวิชาชีพ</button>
    <button class="tab-button" onclick="showTab(event, 'donations')">การบริจาค</button>
</div>

<div class="charts-grid">
    <div class="chart-card">
        <h3>การกระจายตามเพศ</h3>
        <div class="chart-placeholder">
            <canvas id="genderChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h3>การกระจายตามอายุ</h3>
        <div class="chart-placeholder">
            <canvas id="ageChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h3>การกระจายตามสัญชาติ</h3>
        <div class="chart-placeholder">
            <canvas id="nationalityChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h3>การกระจายตามรุ่น</h3>
        <div class="chart-placeholder">
            <canvas id="classChart"></canvas>
        </div>
    </div>
</div>
</div>

<script>
    function loadDashboardData() {
        document.getElementById('totalUsers').textContent = '...';
        document.getElementById('alumniCount').textContent = '...';
        document.getElementById('studentCount').textContent = '...';
        document.getElementById('passedAllCount').textContent = '...'; 
        document.getElementById('passRate').textContent = '...';

        google.script.run.withSuccessHandler(stats => {
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('alumniCount').textContent = stats.alumniCount;
            document.getElementById('studentCount').textContent = stats.studentCount;
            document.getElementById('passedAllCount').textContent = stats.passedAllCount;
            document.getElementById('passRate').textContent = stats.passRate + '%';
        }).getDashboardStats();

        google.script.run.withSuccessHandler(renderGenderChart).getGenderDistribution();
        google.script.run.withSuccessHandler(renderAgeChart).getAgeDistribution();
        google.script.run.withSuccessHandler(renderNationalityChart).getNationalityDistribution();
        google.script.run.withSuccessHandler(renderClassChart).getClassDistribution();
    }
    function renderGenderChart(data) {
        const ctx = document.getElementById('genderChart');
        if (!ctx || !data) return;

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['ชาย', 'หญิง', 'ไม่ระบุ'],
                datasets: [{
                    label: 'จำนวน',
                    data: [data.male, data.female, data.other],
                    backgroundColor: ['#3b82f6', '#ec4899', '#a8a29e'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    /**
     * --- ฟังก์ชันใหม่: สร้างกราฟแท่งแสดงข้อมูลอายุ ---
     * @param {object} data - ข้อมูลจำนวนผู้ใช้ในแต่ละช่วงอายุ
     */
    function renderAgeChart(data) {
        const ctx = document.getElementById('ageChart');
        if (!ctx || !data) return;
        
        const labels = Object.keys(data);
        const values = Object.values(data);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'จำนวนผู้ใช้',
                    data: values,
                    backgroundColor: 'rgba(249, 115, 22, 0.6)', // สีส้ม
                    borderColor: 'rgba(249, 115, 22, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false } // ซ่อน Legend เพราะมีแค่ Dataset เดียว
                }
            }
        });
    }

/**
     * --- ฟังก์ชันใหม่: สร้างกราฟวงกลมแสดงข้อมูลสัญชาติ ---
     * @param {object} data - ข้อมูลจำนวนผู้ใช้ในแต่ละสัญชาติ
     */
    function renderNationalityChart(data) {
        const ctx = document.getElementById('nationalityChart');
        if (!ctx || !data || Object.keys(data).length === 0) return;

        const labels = Object.keys(data);
        const values = Object.values(data);
        
        // สร้างชุดสีแบบไดนามิกเพื่อให้สวยงาม
        const backgroundColors = labels.map((_, i) => `hsl(${i * (360 / labels.length)}, 70%, 60%)`);

        new Chart(ctx, {
            type: 'doughnut', // หรือ 'pie'
            data: {
                labels: labels,
                datasets: [{
                    label: 'จำนวน',
                    data: values,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    /**
     * --- ฟังก์ชันใหม่: สร้างกราฟแท่งแสดงข้อมูลรุ่น ---
     * @param {object} data - ข้อมูลจำนวนผู้ใช้ในแต่ละรุ่น
     */
    function renderClassChart(data) {
        const ctx = document.getElementById('classChart');
        if (!ctx || !data || Object.keys(data).length === 0) return;

        // เรียงข้อมูลตามชื่อรุ่น (Key)
        const sortedData = Object.keys(data).sort().reduce(
          (obj, key) => { 
            obj[key] = data[key]; 
            return obj;
          }, 
          {}
        );
        
        const labels = Object.keys(sortedData);
        const values = Object.values(sortedData);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'จำนวนศิษย์เก่า/นักศึกษา',
                    data: values,
                    backgroundColor: 'rgba(22, 163, 74, 0.6)', // สีเขียว
                    borderColor: 'rgba(22, 163, 74, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { // ทำให้แกน Y เป็นเลขจำนวนเต็ม
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    window.showTab = function(evt, tabName) {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        console.log("เปลี่ยนไปที่แท็บ:", tabName);
    }

    loadDashboardData();
</script>