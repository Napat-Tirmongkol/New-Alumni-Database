<style>
    /* General Card Style */
    .content-card {
        background-color: white; padding: 1.5rem; border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        margin-bottom: 1.5rem;
    }
    .card-header {
        font-size: 1.25rem; font-weight: 600; margin-top: 0; margin-bottom: 1rem;
        padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; display: flex;
        justify-content: space-between; align-items: center;
    }
    
    /* --- CSS ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status Grid --- */
    .progress-subtitle {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;
    }
    .progress-subtitle .title { color: #4b5563; font-weight: 500; }
    .progress-subtitle .counter { color: #f97316; font-weight: 600; font-size: 0.9rem; }
    .subject-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
    }
    .subject-status-item {
        background-color: #f9fafb; border-radius: 0.5rem; padding: 0.75rem 1rem;
        display: flex; align-items: center; gap: 0.75rem;
    }
    .status-circle {
        width: 12px; height: 12px; border-radius: 50%;
        background-color: #d1d5db; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô) */
        flex-shrink: 0; transition: background-color 0.3s;
    }
    .status-circle.passed {
        background-color: #16a34a; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) */
    }
    .subject-name { color: #4b5563; font-size: 0.875rem; }
    /* --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô CSS ‡∏Ç‡∏≠‡∏á Status Grid --- */
    
    .instruction-box { background-color: #eef2ff; border-left: 4px solid #3b82f6; border-radius: 0.25rem; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 0.75rem; font-size: 0.875rem; color: #374151; }
    .instruction-box .icon { flex-shrink: 0; color: #3b82f6; margin-top: 2px; }
    .instruction-box ul { list-style-type: none; padding: 0; margin: 0; }
    .instruction-box li { margin-bottom: 0.35rem; }
    .instruction-box b { font-weight: 700; color: #1e3a8a; }
    .instruction-box strong { font-weight: 700; color: #1e3a8a; display: block; margin-bottom: 0.5rem; }
    .form-row { display: flex; gap: 1.5rem; margin-bottom: 1rem; }
    .form-group { display: flex; flex-direction: column; flex-grow: 1; }
    .form-group label { margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
    .form-group input, .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    .form-actions { text-align: left; margin-top: 1.5rem; }
    .submit-btn { background-color: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; }
    .submit-btn:disabled { background-color: #9ca3af; }
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th, .history-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
    .history-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .status-passed { color: #059669; font-weight: bold; }
    .status-failed { color: #dc2626; }
    .no-history { text-align: center; color: #6b7280; padding: 2rem; }
    .exam-subjects-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1.5rem; }
    .subject-input-group { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
    .subject-input-group span { color: #374151; font-weight: 500; }
    .subject-input-group select { border: 1px solid #d1d5db; border-radius: 6px; padding: 5px 10px; background-color: #f9fafb; }
    .file-upload-group {border-top: 1px solid #e5e7eb;padding-top: 1.5rem;margin-top: 1.5rem;}
    .upload-area {display: flex;flex-direction: column;justify-content: center;align-items: center;border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
}

.upload-area:hover {
    background-color: #f9fafb;
    border-color: #3b82f6;
}

.upload-icon {
    font-size: 2.5rem; /* 40px */
    color: #9ca3af;
    margin-bottom: 0.5rem;
}

.upload-text {
    font-weight: 500;
    color: #374151;
}

.upload-hint {
    font-size: 0.8rem;
    color: #6b7280;
}
</style>

<div class="content-card">
    <h3 class="card-header">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h3>
    <div class="progress-subtitle">
        <span class="title">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
        <span id="licenseProgressLabel" class="counter">0/8</span>
    </div>
    <div class="subject-status-grid">
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject1_Maternity"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏ú‡∏î‡∏∏‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject2_Pediatric"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏≤‡∏£‡∏Å</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject3_Adult"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject4_Geriatric"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject5_Psychiatric"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject6_Community"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏Ø</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject7_Law"></div><span class="subject-name">‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ø</span></div>
        <div class="subject-status-item"><div class="status-circle" id="status-circle-Subject8_Surgical"></div><span class="subject-name">‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏Ø</span></div>
    </div>
</div>

<div class="content-card">
    <h3 class="card-header" style="border-bottom: none; padding-bottom: 0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
    <div class="instruction-box">
        <i class="fas fa-info-circle icon"></i>
        <div>
            <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong>
            <ul>
                <li><b>‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ú‡πà‡∏≤‡∏ô" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</li>
                <li><b>‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</li>
                <li><b>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö:</b> ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</li>
                <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ</li>
            </ul>
        </div>
    </div>

    <form id="licenseExamForm">
        <div class="form-row">
            <div class="form-group">
                <label for="examRound">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</label>
                <input type="number" id="examRound" required>
            </div>
            <div class="form-group">
                <label for="examSession">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà</label>
                <select id="examSession" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</option>
                    <option value="1">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1</option>
                    <option value="2">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2</option>
                    <option value="3">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3</option>
                </select>
            </div>
            <div class="form-group">
                <label for="examYear">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</label>
                <select id="examYear" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®.</option>
                </select>
            </div>
        </div>

        <div class="exam-subjects-grid">
            <div class="subject-input-group" id="form-group-Subject1_Maternity"><span>‡∏Å‡∏≤‡∏£‡∏ú‡∏î‡∏∏‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span><select id="Subject1_Maternity"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject2_Pediatric"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏≤‡∏£‡∏Å</span><select id="Subject2_Pediatric"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject3_Adult"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</span><select id="Subject3_Adult"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject4_Geriatric"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà</span><select id="Subject4_Geriatric"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject5_Psychiatric"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</span><select id="Subject5_Psychiatric"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject6_Community"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏Ø</span><select id="Subject6_Community"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject7_Law"><span>‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ø</span><select id="Subject7_Law"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
            <div class="subject-input-group" id="form-group-Subject8_Surgical"><span>‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏Ø</span><select id="Subject8_Surgical"><option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• -</option><option>‡∏ú‡πà‡∏≤‡∏ô</option><option>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option></select></div>
        </div>

        <div class="file-upload-group">
          <label for="evidenceFile" class="upload-area">
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
              <span id="upload-text" class="upload-text">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ú‡∏•‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</span>
              <span class="upload-hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG, PDF</span>
          </label>
          <input type="file" id="evidenceFile" accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
        </div>

        <div class="form-actions">
            <button type="submit" id="saveExamBtn" class="submit-btn">
                <i class="fas fa-plus" style="margin-right: 8px;"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö
            </button>
        </div>
    </form>
</div>

<div class="content-card">
    <h3 class="card-header">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h3>
    <div class="history-table-wrapper">
        <table class="history-table">
            <thead>
                <tr>
                    <th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà/‡∏õ‡∏µ</th>
                    <th>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</th>
                </tr>
            </thead>
            <tbody id="examHistoryBody">
            </tbody>
        </table>
    </div>
</div>

<script>
    function populateYearDropdown() {
        const yearSelect = document.getElementById('examYear');
        while (yearSelect.options.length > 1) { yearSelect.remove(1); }
        google.script.run.withSuccessHandler(years => {
            if (years && years.length > 0) {
                years.sort((a, b) => b - a);
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }
        }).getExamYears();
    }

    const subjectMap = {
        'Subject1_Maternity': '‡∏Å‡∏≤‡∏£‡∏ú‡∏î‡∏∏‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå', 'Subject2_Pediatric': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏≤‡∏£‡∏Å',
        'Subject3_Adult': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô', 'Subject4_Geriatric': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà',
        'Subject5_Psychiatric': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏', 'Subject6_Community': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏Ø',
        'Subject7_Law': '‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ø', 'Subject8_Surgical': '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏Ø'
    };
    const subjectKeys = Object.keys(subjectMap);

    function loadLicensePageData() {
        const userEmail = sessionStorage.getItem('selectedUserEmail') || sessionStorage.getItem('userEmail');
        if (!userEmail) return;
        google.script.run.withSuccessHandler(updateProgressUI).getLicenseExamStatus(userEmail);
        google.script.run.withSuccessHandler(populateHistoryTable).getLicenseExamHistory(userEmail);
    }

    function updateProgressUI(status) {
        if (!status) return;
        let passedCount = 0;
        subjectKeys.forEach(key => {
            const circleElement = document.getElementById(`status-circle-${key}`);
            if (circleElement) {
                if (status[key] === true) {
                    circleElement.classList.add('passed');
                    passedCount++;
                } else {
                    circleElement.classList.remove('passed');
                }
            }
        });
        document.getElementById('licenseProgressLabel').textContent = `${passedCount}/8`;
        updateExamFormVisibility(status);
    }

    function updateExamFormVisibility(status) {
        let allSubjectsPassed = true;
        subjectKeys.forEach(key => {
            const subjectFormGroup = document.getElementById(`form-group-${key}`);
            if (subjectFormGroup) {
                if (status[key] === true) {
                    subjectFormGroup.style.display = 'none';
                } else {
                    subjectFormGroup.style.display = 'flex';
                    allSubjectsPassed = false;
                }
            }
        });
        const formContainer = document.getElementById('licenseExamForm');
        if (allSubjectsPassed) {
            formContainer.innerHTML = '<p style="text-align:center; color:green; font-weight:bold; padding: 2rem 0;">üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß</p>';
        }
    }

    function populateHistoryTable(history) {
        const tableBody = document.getElementById('examHistoryBody');
        if (!history || history.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="2" class="no-history">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</td></tr>';
            return;
        }
        let tableHtml = '';
        history.forEach(record => {
            let resultsHtml = '<ul>';
            subjectKeys.forEach((key, index) => {
                const result = record[key];
                if (result) {
                    const statusClass = result === '‡∏ú‡πà‡∏≤‡∏ô' ? 'status-passed' : 'status-failed';
                    resultsHtml += `<li>${subjectMap[key]}: <span class="${statusClass}">${result}</span></li>`;
                }
            });
            resultsHtml += '</ul>';
            tableHtml += `
                <tr>
                    <td>${record.ExamRound || ''}/${record.ExamYear || ''}</td>
                    <td>${resultsHtml}</td>
                </tr>
            `;
        });
        tableBody.innerHTML = tableHtml;
    }

    document.getElementById('evidenceFile').addEventListener('change', function() {
    const uploadText = document.getElementById('upload-text');
    if (this.files && this.files.length > 0) {
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
        uploadText.textContent = this.files[0].name;
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
        uploadText.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ú‡∏•‡∏™‡∏≠‡∏ö';
    }
});

    document.getElementById('licenseExamForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const saveBtn = document.getElementById('saveExamBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        const file = document.getElementById('evidenceFile').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const fileData = {
                    base64: event.target.result.split(',')[1],
                    mimeType: file.type,
                    fileName: file.name
                };
                sendDataToServer(fileData);
            };
            reader.readAsDataURL(file);
        } else {
            sendDataToServer(null);
        }
    });

    function sendDataToServer(fileData) {
        const userEmail = sessionStorage.getItem('selectedUserEmail') || sessionStorage.getItem('userEmail');
        if (!userEmail) {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            const saveBtn = document.getElementById('saveExamBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö';
            return;
        }
        const recordData = {
            userEmail: userEmail,
            examRound: document.getElementById('examRound').value,
            examSession: document.getElementById('examSession').value,
            examYear: document.getElementById('examYear').value,
            Subject1_Maternity: document.getElementById('Subject1_Maternity').value,
            Subject2_Pediatric: document.getElementById('Subject2_Pediatric').value,
            Subject3_Adult: document.getElementById('Subject3_Adult').value,
            Subject4_Geriatric: document.getElementById('Subject4_Geriatric').value,
            Subject5_Psychiatric: document.getElementById('Subject5_Psychiatric').value,
            Subject6_Community: document.getElementById('Subject6_Community').value,
            Subject7_Law: document.getElementById('Subject7_Law').value,
            Subject8_Surgical: document.getElementById('Subject8_Surgical').value,
            file: fileData
        };
        google.script.run.withSuccessHandler(onSaveSuccess).saveLicenseExamRecord(recordData);
    }

    function onSaveSuccess(response) {
        alert(response.message);
        const saveBtn = document.getElementById('saveExamBtn');
        saveBtn.disabled = false;
        saveBtn.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö';
        if (response.success) {
            document.getElementById('licenseExamForm').reset();
            loadLicensePageData(); 
            populateYearDropdown();
        }
    }

    loadLicensePageData();
    populateYearDropdown();
</script>