<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body {margin: 0;font-family: "Sarabun", sans-serif;background: linear-gradient(135deg, #ed820e 0%, #ffb27f 100%);display: flex;justify-content: center;align-items: center;height: 100vh;}
        .login-container { background-color: white; padding: 40px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .logo { width: 70px; height: 70px; background-color: rgb(234, 88, 12);  border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        .logo svg { width: 40px; height: 40px; fill: white; }
        h2 { margin-top: 0; margin-bottom: 8px; color: #333; }
        p { color: #777; margin-top: 0; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: bold; }
        input[type="email"], input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background-color: rgb(234, 88, 12); ; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .btn:hover { background-color: #e65100; }
        .links { margin-top: 20px; font-size: 14px; }
        .links a { color: rgb(37, 99, 235); text-decoration: none; }
        #registerLink {color: rgb(22, 163, 74);}
        #error-message { color: red; margin-top: 15px; font-weight: bold; display: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="login-container">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9 12 3zm0 8.69L5.5 8 12 4.31 18.5 8 12 11.69zM17 15.32v-3.13l-5 2.5-5-2.5v3.13l5 2.5 5-2.5z"></path></svg>
        </div>
        <h2 data-lang-key="login_title">ระบบติดตามศิษย์ปัจจุบันและศิษย์เก่า</h2>
        <p data-lang-key="login_subtitle">คณะพยาบาลศาสตร์ มหาวิทยาลัยอัสสัมชัญ</p>
        
        <form id="loginForm">
            <div class="input-group">
                <label for="email" data-lang-key="login_email_label">อีเมล</label>
                <input type="email" id="email" name="email" data-lang-key-placeholder="login_email_placeholder" placeholder="กรอกอีเมลของคุณ" required>
            </div>
            <div class="input-group">
                <label for="password" data-lang-key="login_password_label">รหัสผ่าน</label>
                <input type="password" id="password" name="password" data-lang-key-placeholder="login_password_placeholder" placeholder="กรอกรหัสผ่านของคุณ" required>
            </div>
            <button type="submit" class="btn" id="loginButton" data-lang-key="login_button">เข้าสู่ระบบ</button>
            <div id="error-message"></div>
        </form>
        
        <div class="links">
            <a id="forgotPasswordLink" href="#" data-lang-key="login_forgot_password">ลืมรหัสผ่าน?</a> 
            <span data-lang-key="login_or">หรือ</span> 
            <a id="registerLink" href="#" data-lang-key="login_register">สมัครสมาชิกใหม่</a>
        </div>
    </div>

    <script>
    // สร้างตัวแปรสำหรับเก็บ URL ของเว็บแอปไว้ล่วงหน้า
    let webAppUrl = '';

    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const loginButton = document.getElementById('loginButton');
        const errorMessageDiv = document.getElementById('error-message');
        loginButton.disabled = true;
        loginButton.textContent = 'กำลังตรวจสอบ...';
        errorMessageDiv.style.display = 'none';
        const credentials = { email: this.email.value, password: this.password.value };

        google.script.run
            .withSuccessHandler(result => {
                loginButton.disabled = false;
                loginButton.textContent = 'เข้าสู่ระบบ';
                if (result.success) {
                    const email = document.getElementById('email').value;
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
                    sessionStorage.setItem('userEmail', email);
                    loginButton.textContent = 'สำเร็จ! กำลังเปลี่ยนหน้า...';
                    
                    if (result.user.role === 'Admin') {
                        window.top.location.href = webAppUrl + '?page=admindashboard';
                    } else {
                        window.top.location.href = webAppUrl + '?page=dashboard';
                    }
                } else {
                    errorMessageDiv.textContent = result.message;
                    errorMessageDiv.style.display = 'block';
                }
            })
            .withFailureHandler(error => {
                errorMessageDiv.textContent = 'เกิดข้อผิดพลาดในการสื่อสารกับเซิร์ฟเวอร์: ' + error.message;
                errorMessageDiv.style.display = 'block';
                loginButton.disabled = false;
                loginButton.textContent = 'เข้าสู่ระบบ';
            })
            .validateLogin(credentials);
    });

    document.addEventListener('DOMContentLoaded', function() {
        const registerLink = document.getElementById('registerLink');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        // ดึง URL มาเก็บไว้ในตัวแปร webAppUrl ตอนโหลดหน้าเว็บ
        google.script.run.withSuccessHandler(function(url) {
            webAppUrl = url;
            registerLink.href = url + '?page=register';
            forgotPasswordLink.href = url + '?page=forgotpassword';
        }).getWebAppUrl();
    });
</script>
</body>
</html>